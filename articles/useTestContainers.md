---
title: "Testconteinersを利用してテストを改善しよう" # 記事のタイトル
emoji: "😁" # アイキャッチとして使われる絵文字（1文字だけ）
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: [Go,CI,GitHub Actions,Test, Docker] # タグ。["markdown", "rust", "aws"]のように指定する
published: false # 公開設定（falseにすると下書き）
---

## はじめに

どうもk1mu21です!

テスト時にある環境が必要ですが、タイミングによっては落ちてしまっているのでテストが必ず失敗してしまう可能性は少なからずあると思います
そのためシステムの返り値をモック化してテストをしているといった状況になりがちではないでしょうか？

また、AIがViveCordingをする時代にもなってさらにテストの重要度が上がっているので信頼できるテストを作成する必要があります

今回はそんな状況に対してTestContainersを利用してテスト環境をある程度改善する方法をご紹介したいと思います

## TestContainersとは？

Testcontainersは、Dockerコンテナで動作するあらゆるものの軽量な使い捨てインスタンスを提供するオープンソースライブラリになります

https://testcontainers.com/?language=java

##　使い方

- Goを利用した場合の例になります
- ElasticSearchのコンテナを利用

```Go

```

## メリット

### テスト時にコンテナ化されたシステムを立ち上げることができるので依存を減らせる

- あるシステムが落ちて同通ができないという状況でも、テスト環境内だけで完結できるのでテストの信頼性を上げることができます
    - 結合テストが実施しやすくなるのもありがたい点ですね

### コンテナ化するだけでテスト環境に利用できる

- テスト用に常に立ち上げてる環境があってもコンテナ化すれば利用できるのでランニングコストを減らすことができます

### モックを減らせる

- 実際にコンテナを立ち上げているのでシステムが落ちている場合を考慮した設計にしなくても良いという点がテストの信頼性を上げることにも繋がります
    - 実際の値でテストできるのでAIの変更等にも強くなる

## デメリット

### コンテナを起動するので実行が重い

- TestContainersはコンテナを利用したものになるので、ものによっては起動にとても時間がかかってしまう
    - GitHub Actions上でテストを実行している場合、実行時間が増えれば増えるほど課金量が増えてしまうので考えた上で実行する必要があります
    - 例としてDBを上げるとイメージを持って来るだけではなく、データを入れたり実際の環境に近づけた設定を入れたりするだけで初期化に時間がかかりそうという想像できると思います

### 対策方法

- 一つの対策方法としてTestContainersを利用したテストは別のActionsのジョブとして切り出すことができます
    - １つのジョブにまとまっているとTestContainersが必要ないテスト+必要なテストと時間が合計でかかってしまいます
    - ジョブを分けることで最大実行時間を必要なテストのみまで減らすことが可能です

```yaml

```

### まとめ

TestContainersはテスト内でシステム依存の部分をモック化している場合等に有効です

重いのが正直ネックだと思っていますが、それ以上にテストの信頼性を上げることができるのは大きなリターンだと思うのでぜひ使ってみて下さい！